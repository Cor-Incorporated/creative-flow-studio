// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

// ============================================
// Authentication & User Management
// ============================================

model User {
    id            String    @id @default(cuid())
    email         String    @unique
    emailVerified DateTime?
    name          String?
    image         String?
    role          Role      @default(USER)
    createdAt     DateTime  @default(now())
    updatedAt     DateTime  @updatedAt

    accounts      Account[]
    sessions      Session[]
    conversations Conversation[]
    subscription  Subscription?
    usageLogs     UsageLog[]

    @@map("users")
}

enum Role {
    USER
    PRO
    ENTERPRISE
    ADMIN
}

model Account {
    id                String  @id @default(cuid())
    userId            String
    type              String
    provider          String
    providerAccountId String
    refresh_token     String? @db.Text
    access_token      String? @db.Text
    expires_at        Int?
    token_type        String?
    scope             String?
    id_token          String? @db.Text
    session_state     String?

    user User @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@unique([provider, providerAccountId])
    @@map("accounts")
}

model Session {
    id           String   @id @default(cuid())
    sessionToken String   @unique
    userId       String
    expires      DateTime
    user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@map("sessions")
}

model VerificationToken {
    identifier String
    token      String   @unique
    expires    DateTime

    @@unique([identifier, token])
    @@map("verification_tokens")
}

// ============================================
// Conversation & Messages
// ============================================

model Conversation {
    id        String         @id @default(cuid())
    title     String?
    userId    String
    mode      GenerationMode @default(CHAT)
    createdAt DateTime       @default(now())
    updatedAt DateTime       @updatedAt

    user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
    messages Message[]

    @@index([userId, createdAt])
    @@map("conversations")
}

enum GenerationMode {
    CHAT
    PRO
    SEARCH
    IMAGE
    VIDEO
}

model Message {
    id             String      @id @default(cuid())
    conversationId String
    role           MessageRole
    content        Json // Flexible structure for text, media, sources
    createdAt      DateTime    @default(now())

    conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

    @@index([conversationId, createdAt])
    @@map("messages")
}

enum MessageRole {
    USER
    MODEL
    SYSTEM
}

// ============================================
// Subscription & Billing
// ============================================

model Plan {
    id                  String   @id @default(cuid())
    name                String   @unique
    stripePriceId       String?  @unique
    monthlyPrice        Int // in cents
    features            Json // Flexible JSON for feature flags
    maxRequestsPerMonth Int?
    maxFileSize         Int? // in bytes
    createdAt           DateTime @default(now())
    updatedAt           DateTime @updatedAt

    subscriptions Subscription[]

    @@map("plans")
}

model Subscription {
    id                   String             @id @default(cuid())
    userId               String             @unique
    planId               String
    stripeCustomerId     String?            @unique
    stripeSubscriptionId String?            @unique
    status               SubscriptionStatus @default(INACTIVE)
    currentPeriodStart   DateTime?
    currentPeriodEnd     DateTime?
    cancelAtPeriodEnd    Boolean            @default(false)
    createdAt            DateTime           @default(now())
    updatedAt            DateTime           @updatedAt

    user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
    plan          Plan           @relation(fields: [planId], references: [id])
    paymentEvents PaymentEvent[]

    @@map("subscriptions")
}

enum SubscriptionStatus {
    ACTIVE
    INACTIVE
    TRIALING
    PAST_DUE
    CANCELED
    UNPAID
}

model PaymentEvent {
    id             String   @id @default(cuid())
    subscriptionId String
    stripeEventId  String   @unique
    type           String // e.g., 'invoice.paid', 'payment_intent.succeeded'
    amount         Int? // in cents
    status         String?
    metadata       Json?
    createdAt      DateTime @default(now())

    subscription Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

    @@index([subscriptionId, createdAt])
    @@map("payment_events")
}

// ============================================
// Usage Tracking & Audit
// ============================================

model UsageLog {
    id           String   @id @default(cuid())
    userId       String
    action       String // e.g., 'chat', 'image_generation', 'video_generation'
    resourceType String? // e.g., 'gemini-2.5-flash', 'imagen-4.0'
    metadata     Json?
    createdAt    DateTime @default(now())

    user User @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@index([userId, createdAt])
    @@map("usage_logs")
}

model AuditLog {
    id        String   @id @default(cuid())
    userId    String?
    action    String
    resource  String?
    metadata  Json?
    ipAddress String?
    userAgent String?
    createdAt DateTime @default(now())

    @@index([userId, createdAt])
    @@index([action, createdAt])
    @@map("audit_logs")
}
