# Cloud Build pipeline for BulnaAI (Next.js)
# References:
# - https://cloud.google.com/build/docs/deploying-builds/deploy-cloud-run
# - https://cloud.google.com/sql/docs/postgres/connect-run#terraform (Cloud SQL deploy flags)

options:
    logging: CLOUD_LOGGING_ONLY
    machineType: E2_HIGHCPU_8

tags:
    - creative-flow-studio
    - nextjs

substitutions:
    _REGION: asia-northeast1
    _PROJECT_ID: dataanalyticsclinic
    _REPO: creative-flow-studio
    _IMAGE_NAME: app
    _SERVICE_NAME: creative-flow-studio-dev
    _CLOUD_SQL_INSTANCE: dataanalyticsclinic:asia-northeast1:creative-flow-studio-sql
    _VPC_CONNECTOR: projects/dataanalyticsclinic/locations/asia-northeast1/connectors/dev-serverless-connector
    _SERVICE_ACCOUNT: cloud-run-runtime@dataanalyticsclinic.iam.gserviceaccount.com
    _NEXT_PUBLIC_APP_URL: 'SET_IN_TRIGGER'
    _NEXT_PUBLIC_SUPABASE_URL: 'SET_IN_TRIGGER'

serviceAccount: projects/${_PROJECT_ID}/serviceAccounts/cloud-build-runner@dataanalyticsclinic.iam.gserviceaccount.com

availableSecrets:
    secretManager:
        # DATABASE_URL is included for migration step only, not for Next.js build
        # Use explicit version number to avoid DESTROYED version issues
        # Cloud Build will automatically use the latest enabled version
        - versionName: projects/${_PROJECT_ID}/secrets/database-url/versions/latest
          env: DATABASE_URL
        - versionName: projects/${_PROJECT_ID}/secrets/nextauth-secret/versions/latest
          env: NEXTAUTH_SECRET
        - versionName: projects/${_PROJECT_ID}/secrets/google-client-id/versions/latest
          env: GOOGLE_CLIENT_ID
        - versionName: projects/${_PROJECT_ID}/secrets/google-client-secret/versions/latest
          env: GOOGLE_CLIENT_SECRET
        - versionName: projects/${_PROJECT_ID}/secrets/supabase-service-role/versions/latest
          env: SUPABASE_SERVICE_ROLE_KEY
        - versionName: projects/${_PROJECT_ID}/secrets/stripe-secret-key/versions/latest
          env: STRIPE_SECRET_KEY
        - versionName: projects/${_PROJECT_ID}/secrets/stripe-webhook-secret/versions/latest
          env: STRIPE_WEBHOOK_SECRET
        - versionName: projects/${_PROJECT_ID}/secrets/gemini-api-key/versions/latest
          env: GEMINI_API_KEY
        - versionName: projects/${_PROJECT_ID}/secrets/supabase-anon-key/versions/latest
          env: NEXT_PUBLIC_SUPABASE_ANON_KEY
        - versionName: projects/${_PROJECT_ID}/secrets/stripe-publishable-key/versions/latest
          env: NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY

steps:
    - id: 'Install dependencies'
      name: 'docker.io/library/node@sha256:202ae32103f362765c42bb8283fbec5167cb7c5687feca97ad6bfbf4af3df444'
      entrypoint: bash
      args:
          - '-c'
          - |
              set -euo pipefail
              echo "Cloud Build Node version: $(node --version)"
              npm ci

    - id: 'Generate Prisma client'
      name: 'docker.io/library/node@sha256:202ae32103f362765c42bb8283fbec5167cb7c5687feca97ad6bfbf4af3df444'
      entrypoint: npx
      args: ['prisma', 'generate']

    - id: 'Check Cloud SQL instance exists'
      name: 'gcr.io/google.com/cloudsdktool/cloud-sdk:slim'
      entrypoint: 'bash'
      args:
          - '-c'
          - |
              set -euo pipefail

              echo "üîç Cloud SQL„Ç§„É≥„Çπ„Çø„É≥„Çπ„ÅÆÂ≠òÂú®„ÇíÁ¢∫Ë™ç„Åó„Å¶„ÅÑ„Åæ„Åô..."
              INSTANCE_NAME=$(echo "${_CLOUD_SQL_INSTANCE}" | cut -d':' -f3)
              PROJECT_ID=$(echo "${_CLOUD_SQL_INSTANCE}" | cut -d':' -f1)

              if gcloud sql instances describe "$$INSTANCE_NAME" --project="$$PROJECT_ID" > /dev/null 2>&1; then
                  echo "‚úÖ Cloud SQL„Ç§„É≥„Çπ„Çø„É≥„Çπ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åó„Åü: $$INSTANCE_NAME"
                  echo "true" > /workspace/.cloud_sql_exists
              else
                  echo "‚ö†Ô∏è  Cloud SQL„Ç§„É≥„Çπ„Çø„É≥„Çπ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì: $$INSTANCE_NAME"
                  echo "   „Éû„Ç§„Ç∞„É¨„Éº„Ç∑„Éß„É≥„Çπ„ÉÜ„ÉÉ„Éó„Çí„Çπ„Ç≠„ÉÉ„Éó„Åó„Åæ„Åô„ÄÇ"
                  echo "   Terraform„Åß„Ç§„É≥„Éï„É©„ÇíÂÖà„Å´„Éá„Éó„É≠„Ç§„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ"
                  echo "false" > /workspace/.cloud_sql_exists
              fi
      waitFor: ['Generate Prisma client']

    - id: 'Get Cloud SQL public IP'
      name: 'gcr.io/google.com/cloudsdktool/cloud-sdk:slim'
      entrypoint: 'bash'
      args:
          - '-c'
          - |
              set -euo pipefail

              # Cloud SQL„Ç§„É≥„Çπ„Çø„É≥„Çπ„ÅÆÂ≠òÂú®Á¢∫Ë™ç
              if [ -f /workspace/.cloud_sql_exists ] && [ "$(cat /workspace/.cloud_sql_exists)" = "false" ]; then
                  echo "‚è≠Ô∏è  Cloud SQL„Ç§„É≥„Çπ„Çø„É≥„Çπ„ÅåÂ≠òÂú®„Åó„Å™„ÅÑ„Åü„ÇÅ„ÄÅ„Çπ„Ç≠„ÉÉ„Éó„Åó„Åæ„Åô„ÄÇ"
                  exit 0
              fi

              echo "üîç Cloud SQL„ÅÆ„Éë„Éñ„É™„ÉÉ„ÇØIP„ÇíÂèñÂæó„Åó„Å¶„ÅÑ„Åæ„Åô..."
              INSTANCE_NAME=$(echo "${_CLOUD_SQL_INSTANCE}" | cut -d':' -f3)
              PROJECT_ID=$(echo "${_CLOUD_SQL_INSTANCE}" | cut -d':' -f1)

              PUBLIC_IP=$(gcloud sql instances describe "$$INSTANCE_NAME" \
                  --project="$$PROJECT_ID" \
                  --format="value(ipAddresses[0].ipAddress)" 2>/dev/null || echo "")

              if [ -z "$$PUBLIC_IP" ]; then
                  echo "‚ö†Ô∏è  „Éë„Éñ„É™„ÉÉ„ÇØIP„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇTerraform„Åßipv4_enabled=true„ÇíË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ"
                  echo "false" > /workspace/.cloud_sql_has_public_ip
              else
                  echo "‚úÖ „Éë„Éñ„É™„ÉÉ„ÇØIP: $$PUBLIC_IP"
                  echo "$$PUBLIC_IP" > /workspace/.cloud_sql_public_ip
                  echo "true" > /workspace/.cloud_sql_has_public_ip
              fi
      waitFor: ['Check Cloud SQL instance exists']

    - id: 'Apply database migrations'
      name: 'docker.io/library/node@sha256:202ae32103f362765c42bb8283fbec5167cb7c5687feca97ad6bfbf4af3df444'
      entrypoint: 'bash'
      args:
          - '-c'
          - |
              set -euo pipefail

              # DATABASE_URL„ÇíÂèñÂæóÔºàSecret Manager„Åã„ÇâÁõ¥Êé•ÂèñÂæó„Åó„Å¶DESTROYED„Éê„Éº„Ç∏„Éß„É≥„ÇíÂõûÈÅøÔºâ
              echo "üîë „Éá„Éº„Çø„Éô„Éº„ÇπÊé•Á∂öÊÉÖÂ†±„ÇíÂèñÂæó„Åó„Å¶„ÅÑ„Åæ„Åô..."
              if [ -z "$$DATABASE_URL" ]; then
                  echo "‚ùå DATABASE_URLÁí∞Â¢ÉÂ§âÊï∞„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì"
                  exit 1
              fi

              # Cloud SQL„Ç§„É≥„Çπ„Çø„É≥„Çπ„ÅÆÂ≠òÂú®Á¢∫Ë™ç
              if [ -f /workspace/.cloud_sql_exists ] && [ "$(cat /workspace/.cloud_sql_exists)" = "false" ]; then
                  echo "‚è≠Ô∏è  Cloud SQL„Ç§„É≥„Çπ„Çø„É≥„Çπ„ÅåÂ≠òÂú®„Åó„Å™„ÅÑ„Åü„ÇÅ„ÄÅ„Éû„Ç§„Ç∞„É¨„Éº„Ç∑„Éß„É≥„Çí„Çπ„Ç≠„ÉÉ„Éó„Åó„Åæ„Åô„ÄÇ"
                  exit 0
              fi

              # „Éë„Éñ„É™„ÉÉ„ÇØIP„ÅÆÁ¢∫Ë™ç
              if [ -f /workspace/.cloud_sql_has_public_ip ] && [ "$(cat /workspace/.cloud_sql_has_public_ip)" = "false" ]; then
                  echo "‚ö†Ô∏è  Cloud SQL„Å´„Éë„Éñ„É™„ÉÉ„ÇØIP„Åå„Å™„ÅÑ„Åü„ÇÅ„ÄÅ„Éû„Ç§„Ç∞„É¨„Éº„Ç∑„Éß„É≥„Çí„Çπ„Ç≠„ÉÉ„Éó„Åó„Åæ„Åô„ÄÇ"
                  echo "   Cloud Run„Éá„Éó„É≠„Ç§Âæå„ÄÅUnix socketÁµåÁî±„Åß„Éû„Ç§„Ç∞„É¨„Éº„Ç∑„Éß„É≥„ÇíÂÆüË°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ"
                  exit 0
              fi

              PUBLIC_IP=$(cat /workspace/.cloud_sql_public_ip)
              echo "üîó Cloud SQL „Éë„Éñ„É™„ÉÉ„ÇØIPÁµåÁî±„ÅßÊé•Á∂ö„Åó„Åæ„Åô: $$PUBLIC_IP"

              # DATABASE_URL„Åã„Çâ„É¶„Éº„Ç∂„ÉºÂêç„ÄÅ„Éë„Çπ„ÉØ„Éº„Éâ„ÄÅDBÂêç„ÇíÊäΩÂá∫„Åó„Å¶Êñ∞„Åó„ÅÑURL„ÇíÊßãÁØâ
              # ÂÖÉ„ÅÆÂΩ¢Âºè: postgresql://user:pass@/db?host=/cloudsql/...
              DB_URL="$$DATABASE_URL"

              # „É¶„Éº„Ç∂„ÉºÂêç„ÇíÊäΩÂá∫
              DB_USER=$(echo "$$DB_URL" | sed -n 's|postgresql://\([^:]*\):.*|\1|p')
              # „Éë„Çπ„ÉØ„Éº„Éâ„ÇíÊäΩÂá∫Ôºà@/„Çà„ÇäÂâç„ÅÆ:‰ª•ÈôçÔºâ
              DB_PASS=$(echo "$$DB_URL" | sed -n 's|postgresql://[^:]*:\([^@]*\)@.*|\1|p')
              # DBÂêç„ÇíÊäΩÂá∫Ôºà@/„Å®?„ÅÆÈñìÔºâ
              DB_NAME=$(echo "$$DB_URL" | sed -n 's|.*@/\([^?]*\)?.*|\1|p')

              echo "  „É¶„Éº„Ç∂„Éº: $$DB_USER"
              echo "  DBÂêç: $$DB_NAME"

              # „Éë„Éñ„É™„ÉÉ„ÇØIPÁµåÁî±„ÅÆDATABASE_URL„ÇíÊßãÁØâÔºàSSLÂøÖÈ†àÔºâ
              export DATABASE_URL="postgresql://$$DB_USER:$$DB_PASS@$$PUBLIC_IP:5432/$$DB_NAME?sslmode=require"
              echo "  Êé•Á∂öÂÖà: postgresql://$$DB_USER:****@$$PUBLIC_IP:5432/$$DB_NAME?sslmode=require"

              # Prisma„Éû„Ç§„Ç∞„É¨„Éº„Ç∑„Éß„É≥„ÇíÂÆüË°å
              echo "üîÑ „Éá„Éº„Çø„Éô„Éº„Çπ„Éû„Ç§„Ç∞„É¨„Éº„Ç∑„Éß„É≥„ÇíÈÅ©Áî®„Åó„Å¶„ÅÑ„Åæ„Åô..."

              # Êé•Á∂ö„Ç®„É©„ÉºÁî®„ÅÆ„É™„Éà„É©„Ç§Ë®≠ÂÆö
              MAX_RETRIES=5
              RETRY_COUNT=0

              set +e
              while [ $$RETRY_COUNT -lt $$MAX_RETRIES ]; do
                  ERROR_OUTPUT=$(npx prisma migrate deploy 2>&1)
                  EXIT_CODE=$$?

                  if [ $$EXIT_CODE -eq 0 ]; then
                      echo "‚úÖ „Éû„Ç§„Ç∞„É¨„Éº„Ç∑„Éß„É≥„ÅåÊ≠£Â∏∏„Å´ÂÆå‰∫Ü„Åó„Åæ„Åó„Åü"
                      exit 0
                  fi

                  # Êé•Á∂ö„Ç®„É©„Éº„ÅÆÂ†¥Âêà„ÅØ„É™„Éà„É©„Ç§
                  if echo "$$ERROR_OUTPUT" | grep -qE "(P1001|P1002|ECONNREFUSED|timeout)"; then
                      RETRY_COUNT=$$((RETRY_COUNT + 1))
                      echo "  Êé•Á∂ö„Ç®„É©„Éº„ÄÇË©¶Ë°å $$RETRY_COUNT/$$MAX_RETRIES..."
                      sleep 3
                      continue
                  fi

                  # P3005: Êó¢Â≠ò„Çπ„Ç≠„Éº„Éû„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØbaseline„ÇíË®≠ÂÆö
                  if echo "$$ERROR_OUTPUT" | grep -q "P3005"; then
                      echo "‚ö†Ô∏è  Êó¢Â≠ò„ÅÆ„Çπ„Ç≠„Éº„Éû„ÅåÂ≠òÂú®„Åó„Åæ„Åô„ÄÇbaseline„ÇíË®≠ÂÆö„Åó„Åæ„Åô..."
                      FIRST_MIGRATION=$(ls -1 prisma/migrations 2>/dev/null | grep -v "^_" | head -1)
                      if [ -n "$$FIRST_MIGRATION" ]; then
                          npx prisma migrate resolve --applied "$$FIRST_MIGRATION" 2>&1 || true
                          continue
                      fi
                  fi

                  # „Åù„ÅÆ‰ªñ„ÅÆ„Ç®„É©„Éº
                  echo "‚ùå „Éû„Ç§„Ç∞„É¨„Éº„Ç∑„Éß„É≥„Ç®„É©„Éº:"
                  echo "$$ERROR_OUTPUT"
                  exit 1
              done
              set -e

              echo "‚ùå „Éû„Ç§„Ç∞„É¨„Éº„Ç∑„Éß„É≥„Å´Â§±Êïó„Åó„Åæ„Åó„ÅüÔºà$$MAX_RETRIESÂõûË©¶Ë°åÔºâ"
              exit 1
      secretEnv:
          - DATABASE_URL
      waitFor: ['Get Cloud SQL public IP']

    - id: 'Build Next.js app'
      name: 'docker.io/library/node@sha256:202ae32103f362765c42bb8283fbec5167cb7c5687feca97ad6bfbf4af3df444'
      entrypoint: npm
      args: ['run', 'build']
      env:
          - 'NEXT_PUBLIC_APP_URL=${_NEXT_PUBLIC_APP_URL}'
          - 'NEXT_PUBLIC_SUPABASE_URL=${_NEXT_PUBLIC_SUPABASE_URL}'
          # NOTE: DATABASE_URL is NOT set during build - it's only set at runtime in Cloud Run
          # This prevents Next.js from hardcoding the DATABASE_URL during build
      secretEnv:
          - NEXTAUTH_SECRET
          - GOOGLE_CLIENT_ID
          - GOOGLE_CLIENT_SECRET
          - SUPABASE_SERVICE_ROLE_KEY
          - STRIPE_SECRET_KEY
          - STRIPE_WEBHOOK_SECRET
          - GEMINI_API_KEY
          - NEXT_PUBLIC_SUPABASE_ANON_KEY
          - NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY

    - id: 'Build container image'
      name: 'gcr.io/cloud-builders/docker'
      entrypoint: 'bash'
      env:
          - 'NEXT_PUBLIC_APP_URL=${_NEXT_PUBLIC_APP_URL}'
          - 'NEXT_PUBLIC_SUPABASE_URL=${_NEXT_PUBLIC_SUPABASE_URL}'
      secretEnv:
          - NEXTAUTH_SECRET
          - GOOGLE_CLIENT_ID
          - GOOGLE_CLIENT_SECRET
          - GEMINI_API_KEY
          - NEXT_PUBLIC_SUPABASE_ANON_KEY
          - NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY
      args:
          - '-c'
          - |
              docker build \
                --build-arg NEXT_PUBLIC_APP_URL="${_NEXT_PUBLIC_APP_URL}" \
                --build-arg NEXT_PUBLIC_SUPABASE_URL="${_NEXT_PUBLIC_SUPABASE_URL}" \
                --build-arg NEXT_PUBLIC_SUPABASE_ANON_KEY="$$NEXT_PUBLIC_SUPABASE_ANON_KEY" \
                --build-arg NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY="$$NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY" \
                --build-arg GOOGLE_CLIENT_ID=$$GOOGLE_CLIENT_ID \
                --build-arg GOOGLE_CLIENT_SECRET=$$GOOGLE_CLIENT_SECRET \
                --build-arg NEXTAUTH_SECRET=$$NEXTAUTH_SECRET \
                --build-arg GEMINI_API_KEY=$$GEMINI_API_KEY \
                -t asia-northeast1-docker.pkg.dev/${_PROJECT_ID}/${_REPO}/${_IMAGE_NAME}:${SHORT_SHA} \
                -f Dockerfile \
                .

    - id: 'Push container image'
      name: 'gcr.io/cloud-builders/docker'
      args:
          - 'push'
          - 'asia-northeast1-docker.pkg.dev/${_PROJECT_ID}/${_REPO}/${_IMAGE_NAME}:${SHORT_SHA}'

    - id: 'Deploy to Cloud Run'
      name: 'gcr.io/google.com/cloudsdktool/cloud-sdk:slim'
      entrypoint: gcloud
      args:
          - 'run'
          - 'deploy'
          - '${_SERVICE_NAME}'
          - '--project=${_PROJECT_ID}'
          - '--region=${_REGION}'
          - '--image=asia-northeast1-docker.pkg.dev/${_PROJECT_ID}/${_REPO}/${_IMAGE_NAME}:${SHORT_SHA}'
          - '--service-account=${_SERVICE_ACCOUNT}'
          - '--platform=managed'
          - '--vpc-connector=${_VPC_CONNECTOR}'
          - '--set-cloudsql-instances=${_CLOUD_SQL_INSTANCE}'
          - '--ingress=all'
          - '--allow-unauthenticated'
          - '--quiet'

images:
    - 'asia-northeast1-docker.pkg.dev/${_PROJECT_ID}/${_REPO}/${_IMAGE_NAME}:${SHORT_SHA}'
