# Cloud Build pipeline for Creative Flow Studio (Next.js)
# References:
# - https://cloud.google.com/build/docs/deploying-builds/deploy-cloud-run
# - https://cloud.google.com/sql/docs/postgres/connect-run#terraform (Cloud SQL deploy flags)

options:
    logging: CLOUD_LOGGING_ONLY
    machineType: E2_HIGHCPU_8
    pool:
        name: projects/${_PROJECT_ID}/locations/${_REGION}/workerPools/cloud-build-private-pool

tags:
    - creative-flow-studio
    - nextjs

substitutions:
    _REGION: asia-northeast1
    _PROJECT_ID: dataanalyticsclinic
    _REPO: creative-flow-studio
    _IMAGE_NAME: app
    _SERVICE_NAME: creative-flow-studio-dev
    _CLOUD_SQL_INSTANCE: dataanalyticsclinic:asia-northeast1:creative-flow-studio-sql
    _VPC_CONNECTOR: projects/dataanalyticsclinic/locations/asia-northeast1/connectors/dev-serverless-connector
    _SERVICE_ACCOUNT: cloud-run-runtime@dataanalyticsclinic.iam.gserviceaccount.com
    _NEXT_PUBLIC_APP_URL: 'SET_IN_TRIGGER'
    _NEXT_PUBLIC_SUPABASE_URL: 'SET_IN_TRIGGER'

serviceAccount: projects/${_PROJECT_ID}/serviceAccounts/cloud-build-runner@dataanalyticsclinic.iam.gserviceaccount.com

availableSecrets:
    secretManager:
        # DATABASE_URL is included for migration step only, not for Next.js build
        - versionName: projects/${_PROJECT_ID}/secrets/database-url/versions/latest
          env: DATABASE_URL
        - versionName: projects/${_PROJECT_ID}/secrets/nextauth-secret/versions/latest
          env: NEXTAUTH_SECRET
        - versionName: projects/${_PROJECT_ID}/secrets/google-client-id/versions/latest
          env: GOOGLE_CLIENT_ID
        - versionName: projects/${_PROJECT_ID}/secrets/google-client-secret/versions/latest
          env: GOOGLE_CLIENT_SECRET
        - versionName: projects/${_PROJECT_ID}/secrets/supabase-service-role/versions/latest
          env: SUPABASE_SERVICE_ROLE_KEY
        - versionName: projects/${_PROJECT_ID}/secrets/stripe-secret-key/versions/latest
          env: STRIPE_SECRET_KEY
        - versionName: projects/${_PROJECT_ID}/secrets/stripe-webhook-secret/versions/latest
          env: STRIPE_WEBHOOK_SECRET
        - versionName: projects/${_PROJECT_ID}/secrets/gemini-api-key/versions/latest
          env: GEMINI_API_KEY
        - versionName: projects/${_PROJECT_ID}/secrets/supabase-anon-key/versions/latest
          env: NEXT_PUBLIC_SUPABASE_ANON_KEY
        - versionName: projects/${_PROJECT_ID}/secrets/stripe-publishable-key/versions/latest
          env: NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY

steps:
    - id: 'Install dependencies'
      name: 'docker.io/library/node@sha256:202ae32103f362765c42bb8283fbec5167cb7c5687feca97ad6bfbf4af3df444'
      entrypoint: bash
      args:
          - '-c'
          - |
              set -euo pipefail
              echo "Cloud Build Node version: $(node --version)"
              npm ci

    - id: 'Generate Prisma client'
      name: 'docker.io/library/node@sha256:202ae32103f362765c42bb8283fbec5167cb7c5687feca97ad6bfbf4af3df444'
      entrypoint: npx
      args: ['prisma', 'generate']

    - id: 'Apply database migrations'
      name: 'docker.io/library/node@sha256:202ae32103f362765c42bb8283fbec5167cb7c5687feca97ad6bfbf4af3df444'
      entrypoint: 'bash'
      args:
          - '-c'
          - |
              set -euo pipefail
              
              # Cloud SQL Proxy v2„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
              echo "üì• Cloud SQL Proxy v2„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åó„Å¶„ÅÑ„Åæ„Åô..."
              curl -o cloud-sql-proxy https://storage.googleapis.com/cloud-sql-connectors/cloud-sql-proxy/v2.19.0/cloud-sql-proxy.linux.amd64
              chmod +x cloud-sql-proxy
              
              # Cloud SQL Proxy„Çí„Éê„ÉÉ„ÇØ„Ç∞„É©„Ç¶„É≥„Éâ„ÅßËµ∑Âãï
              echo "üöÄ Cloud SQL Proxy„ÇíËµ∑Âãï„Åó„Å¶„ÅÑ„Åæ„Åô..."
              echo "   „Ç§„É≥„Çπ„Çø„É≥„Çπ: ${_CLOUD_SQL_INSTANCE}"
              echo "   „Éó„É©„Ç§„Éô„Éº„ÉàIPÊé•Á∂ö„Çí‰ΩøÁî®„Åó„Åæ„Åô"
              ./cloud-sql-proxy ${_CLOUD_SQL_INSTANCE} --port=5432 --address=127.0.0.1 --private-ip > /tmp/cloud-sql-proxy.log 2>&1 &
              PROXY_PID=$!
              
              # Proxy„ÅåËµ∑Âãï„Åô„Çã„Åæ„ÅßÂæÖÊ©üÔºàÊúÄÂ§ß30ÁßíÔºâ
              echo "‚è≥ Cloud SQL Proxy„ÅÆËµ∑Âãï„ÇíÂæÖÊ©ü„Åó„Å¶„ÅÑ„Åæ„Åô..."
              for i in {1..30}; do
                  if ps -p $$PROXY_PID > /dev/null 2>&1; then
                      # „Éù„Éº„Éà5432„Åå„É™„ÉÉ„Çπ„É≥„Åó„Å¶„ÅÑ„Çã„ÅãÁ¢∫Ë™çÔºàtimeout„Ç≥„Éû„É≥„Éâ„Çí‰ΩøÁî®Ôºâ
                      if timeout 1 bash -c "echo > /dev/tcp/127.0.0.1/5432" 2>/dev/null; then
                          echo "‚úÖ Cloud SQL Proxy„ÅåËµ∑Âãï„Åó„Åæ„Åó„Åü (PID: $$PROXY_PID, Ë©¶Ë°å: $$i/30)"
                          break
                      fi
                  else
                      echo "‚ùå Cloud SQL Proxy„ÅÆËµ∑Âãï„Å´Â§±Êïó„Åó„Åæ„Åó„Åü"
                      cat /tmp/cloud-sql-proxy.log
                      exit 1
                  fi
                  if [ $$i -eq 30 ]; then
                      echo "‚ùå Cloud SQL Proxy„ÅÆËµ∑Âãï„Åå„Çø„Ç§„É†„Ç¢„Ç¶„Éà„Åó„Åæ„Åó„Åü"
                      cat /tmp/cloud-sql-proxy.log
                      exit 1
                  fi
                  sleep 1
              done
              
              # DATABASE_URL„ÇíÂèñÂæó„Åó„Å¶„ÄÅlocalhostÁµåÁî±„Å´Â§âÊèõ
              echo "üîë „Éá„Éº„Çø„Éô„Éº„ÇπÊé•Á∂öÊÉÖÂ†±„ÇíÂèñÂæó„Åó„Å¶„ÅÑ„Åæ„Åô..."
              DB_URL=$$DATABASE_URL
              echo "  ÂÖÉ„ÅÆDATABASE_URL: $$DB_URL"
              
              # Unix socketÂΩ¢Âºè„Åã„ÇâTCPÂΩ¢Âºè„Å´Â§âÊèõ
              # postgresql://user:pass@/db?host=/cloudsql/... -> postgresql://user:pass@127.0.0.1:5432/db
              DB_URL_LOCAL=$(echo "$$DB_URL" | sed 's|host=/cloudsql/[^?]*||' | sed 's|@/|@127.0.0.1:5432/|')
              echo "  Â§âÊèõÂæå„ÅÆDATABASE_URL: $$DB_URL_LOCAL"
              
              # Prisma„Éû„Ç§„Ç∞„É¨„Éº„Ç∑„Éß„É≥„ÇíÂÆüË°åÔºàÊé•Á∂öÁ¢∫Ë™ç„ÇÇÂÖº„Å≠„ÇãÔºâ
              echo "üîÑ „Éá„Éº„Çø„Éô„Éº„Çπ„Éû„Ç§„Ç∞„É¨„Éº„Ç∑„Éß„É≥„ÇíÈÅ©Áî®„Åó„Å¶„ÅÑ„Åæ„Åô..."
              export DATABASE_URL="$$DB_URL_LOCAL"
              MAX_RETRIES=30
              RETRY_COUNT=0
              
              # set -e„Çí‰∏ÄÊôÇÁöÑ„Å´ÁÑ°ÂäπÂåñ„Åó„Å¶„Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞„ÇíË°å„ÅÜ
              set +e
              while [ $$RETRY_COUNT -lt $$MAX_RETRIES ]; do
                  # Prisma migrate deploy„ÇíÂÆüË°å
                  ERROR_OUTPUT=$(npx prisma migrate deploy 2>&1)
                  EXIT_CODE=$$?
                  
                  if [ $$EXIT_CODE -eq 0 ]; then
                      echo "‚úÖ „Éû„Ç§„Ç∞„É¨„Éº„Ç∑„Éß„É≥„ÅåÊ≠£Â∏∏„Å´ÂÆå‰∫Ü„Åó„Åæ„Åó„Åü"
                      set -e
                      break
                  fi
                  
                  # Êé•Á∂ö„Ç®„É©„ÉºÔºàP1001Ôºâ„ÅÆÂ†¥Âêà„ÅØ„É™„Éà„É©„Ç§
                  if echo "$$ERROR_OUTPUT" | grep -q "P1001"; then
                      RETRY_COUNT=$$((RETRY_COUNT + 1))
                      echo "  Êé•Á∂ö„Ç®„É©„Éº„ÄÇË©¶Ë°å $$RETRY_COUNT/$$MAX_RETRIES..."
                      if [ $$((RETRY_COUNT % 5)) -eq 0 ]; then
                          echo "  „Ç®„É©„ÉºË©≥Á¥∞: $$ERROR_OUTPUT"
                          echo "  Cloud SQL Proxy„É≠„Ç∞ÔºàÊúÄÊñ∞10Ë°åÔºâ:"
                          tail -n 10 /tmp/cloud-sql-proxy.log || true
                      fi
                      sleep 2
                  else
                      # Êé•Á∂ö„Ç®„É©„Éº‰ª•Â§ñ„ÅÆÂ†¥Âêà„ÅØ„Ç®„É©„Éº„ÇíË°®Á§∫„Åó„Å¶ÁµÇ‰∫Ü
                      set -e
                      echo "‚ùå „Éû„Ç§„Ç∞„É¨„Éº„Ç∑„Éß„É≥„Ç®„É©„Éº:"
                      echo "$$ERROR_OUTPUT"
                      echo ""
                      echo "Cloud SQL Proxy„É≠„Ç∞:"
                      cat /tmp/cloud-sql-proxy.log
                      exit 1
                  fi
              done
              set -e
              
              if [ $$RETRY_COUNT -eq $$MAX_RETRIES ]; then
                  echo "‚ùå „Éá„Éº„Çø„Éô„Éº„ÇπÊé•Á∂ö„ÅÆÁ¢∫Á´ã„Å´Â§±Êïó„Åó„Åæ„Åó„ÅüÔºà$$MAX_RETRIESÂõûË©¶Ë°åÔºâ"
                  echo "Cloud SQL Proxy„É≠„Ç∞:"
                  cat /tmp/cloud-sql-proxy.log
                  exit 1
              fi
              
              # Proxy„ÇíÂÅúÊ≠¢
              echo "üõë Cloud SQL Proxy„ÇíÂÅúÊ≠¢„Åó„Å¶„ÅÑ„Åæ„Åô..."
              kill $$PROXY_PID 2>/dev/null || true
              wait $$PROXY_PID 2>/dev/null || true
              
              echo "‚úÖ „Éû„Ç§„Ç∞„É¨„Éº„Ç∑„Éß„É≥„ÅåÊ≠£Â∏∏„Å´ÂÆå‰∫Ü„Åó„Åæ„Åó„Åü"
      secretEnv:
          - DATABASE_URL
      waitFor: ['Generate Prisma client']

    - id: 'Build Next.js app'
      name: 'docker.io/library/node@sha256:202ae32103f362765c42bb8283fbec5167cb7c5687feca97ad6bfbf4af3df444'
      entrypoint: npm
      args: ['run', 'build']
      env:
          - 'NEXT_PUBLIC_APP_URL=${_NEXT_PUBLIC_APP_URL}'
          - 'NEXT_PUBLIC_SUPABASE_URL=${_NEXT_PUBLIC_SUPABASE_URL}'
          # NOTE: DATABASE_URL is NOT set during build - it's only set at runtime in Cloud Run
          # This prevents Next.js from hardcoding the DATABASE_URL during build
      secretEnv:
          - NEXTAUTH_SECRET
          - GOOGLE_CLIENT_ID
          - GOOGLE_CLIENT_SECRET
          - SUPABASE_SERVICE_ROLE_KEY
          - STRIPE_SECRET_KEY
          - STRIPE_WEBHOOK_SECRET
          - GEMINI_API_KEY
          - NEXT_PUBLIC_SUPABASE_ANON_KEY
          - NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY

    - id: 'Build container image'
      name: 'gcr.io/cloud-builders/docker'
      entrypoint: 'bash'
      env:
          - 'NEXT_PUBLIC_APP_URL=${_NEXT_PUBLIC_APP_URL}'
          - 'NEXT_PUBLIC_SUPABASE_URL=${_NEXT_PUBLIC_SUPABASE_URL}'
      secretEnv:
          - NEXTAUTH_SECRET
          - GOOGLE_CLIENT_ID
          - GOOGLE_CLIENT_SECRET
          - GEMINI_API_KEY
          - NEXT_PUBLIC_SUPABASE_ANON_KEY
          - NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY
      args:
          - '-c'
          - |
              docker build \
                --build-arg NEXT_PUBLIC_APP_URL="${_NEXT_PUBLIC_APP_URL}" \
                --build-arg NEXT_PUBLIC_SUPABASE_URL="${_NEXT_PUBLIC_SUPABASE_URL}" \
                --build-arg NEXT_PUBLIC_SUPABASE_ANON_KEY="$$NEXT_PUBLIC_SUPABASE_ANON_KEY" \
                --build-arg NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY="$$NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY" \
                --build-arg GOOGLE_CLIENT_ID=$$GOOGLE_CLIENT_ID \
                --build-arg GOOGLE_CLIENT_SECRET=$$GOOGLE_CLIENT_SECRET \
                --build-arg NEXTAUTH_SECRET=$$NEXTAUTH_SECRET \
                --build-arg GEMINI_API_KEY=$$GEMINI_API_KEY \
                -t asia-northeast1-docker.pkg.dev/${_PROJECT_ID}/${_REPO}/${_IMAGE_NAME}:${SHORT_SHA} \
                -f Dockerfile \
                .

    - id: 'Push container image'
      name: 'gcr.io/cloud-builders/docker'
      args:
          - 'push'
          - 'asia-northeast1-docker.pkg.dev/${_PROJECT_ID}/${_REPO}/${_IMAGE_NAME}:${SHORT_SHA}'

    - id: 'Deploy to Cloud Run'
      name: 'gcr.io/google.com/cloudsdktool/cloud-sdk:slim'
      entrypoint: gcloud
      args:
          - 'run'
          - 'deploy'
          - '${_SERVICE_NAME}'
          - '--project=${_PROJECT_ID}'
          - '--region=${_REGION}'
          - '--image=asia-northeast1-docker.pkg.dev/${_PROJECT_ID}/${_REPO}/${_IMAGE_NAME}:${SHORT_SHA}'
          - '--service-account=${_SERVICE_ACCOUNT}'
          - '--platform=managed'
          - '--vpc-connector=${_VPC_CONNECTOR}'
          - '--set-cloudsql-instances=${_CLOUD_SQL_INSTANCE}'
          - '--ingress=all'
          - '--allow-unauthenticated'
          - '--quiet'

images:
    - 'asia-northeast1-docker.pkg.dev/${_PROJECT_ID}/${_REPO}/${_IMAGE_NAME}:${SHORT_SHA}'
