# Cloud Build pipeline for BulnaAI (Next.js)
# References:
# - https://cloud.google.com/build/docs/deploying-builds/deploy-cloud-run
# - https://cloud.google.com/sql/docs/postgres/connect-run#terraform (Cloud SQL deploy flags)

options:
    logging: CLOUD_LOGGING_ONLY
    machineType: E2_HIGHCPU_8

tags:
    - creative-flow-studio
    - nextjs

substitutions:
    _REGION: asia-northeast1
    _PROJECT_ID: dataanalyticsclinic
    _REPO: creative-flow-studio
    _IMAGE_NAME: app
    _SERVICE_NAME: creative-flow-studio-dev
    _CLOUD_SQL_INSTANCE: dataanalyticsclinic:asia-northeast1:creative-flow-studio-sql
    _VPC_CONNECTOR: projects/dataanalyticsclinic/locations/asia-northeast1/connectors/dev-serverless-connector
    _SERVICE_ACCOUNT: cloud-run-runtime@dataanalyticsclinic.iam.gserviceaccount.com
    _NEXT_PUBLIC_APP_URL: 'SET_IN_TRIGGER'
    _NEXT_PUBLIC_SUPABASE_URL: 'SET_IN_TRIGGER'

serviceAccount: projects/${_PROJECT_ID}/serviceAccounts/cloud-build-runner@dataanalyticsclinic.iam.gserviceaccount.com

availableSecrets:
    secretManager:
        # DATABASE_URL is included for migration step only, not for Next.js build
        # Use explicit version number to avoid DESTROYED version issues
        # Cloud Build will automatically use the latest enabled version
        - versionName: projects/${_PROJECT_ID}/secrets/database-url/versions/latest
          env: DATABASE_URL
        - versionName: projects/${_PROJECT_ID}/secrets/nextauth-secret/versions/latest
          env: NEXTAUTH_SECRET
        - versionName: projects/${_PROJECT_ID}/secrets/google-client-id/versions/latest
          env: GOOGLE_CLIENT_ID
        - versionName: projects/${_PROJECT_ID}/secrets/google-client-secret/versions/latest
          env: GOOGLE_CLIENT_SECRET
        - versionName: projects/${_PROJECT_ID}/secrets/supabase-service-role/versions/latest
          env: SUPABASE_SERVICE_ROLE_KEY
        - versionName: projects/${_PROJECT_ID}/secrets/stripe-secret-key/versions/latest
          env: STRIPE_SECRET_KEY
        - versionName: projects/${_PROJECT_ID}/secrets/stripe-webhook-secret/versions/latest
          env: STRIPE_WEBHOOK_SECRET
        - versionName: projects/${_PROJECT_ID}/secrets/gemini-api-key/versions/latest
          env: GEMINI_API_KEY
        - versionName: projects/${_PROJECT_ID}/secrets/supabase-anon-key/versions/latest
          env: NEXT_PUBLIC_SUPABASE_ANON_KEY
        - versionName: projects/${_PROJECT_ID}/secrets/stripe-publishable-key/versions/latest
          env: NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY

steps:
    - id: 'Install dependencies'
      name: 'docker.io/library/node@sha256:202ae32103f362765c42bb8283fbec5167cb7c5687feca97ad6bfbf4af3df444'
      entrypoint: bash
      args:
          - '-c'
          - |
              set -euo pipefail
              echo "Cloud Build Node version: $(node --version)"
              npm ci

    - id: 'Generate Prisma client'
      name: 'docker.io/library/node@sha256:202ae32103f362765c42bb8283fbec5167cb7c5687feca97ad6bfbf4af3df444'
      entrypoint: npx
      args: ['prisma', 'generate']

    - id: 'Check Cloud SQL instance exists'
      name: 'gcr.io/google.com/cloudsdktool/cloud-sdk:slim'
      entrypoint: 'bash'
      args:
          - '-c'
          - |
              set -euo pipefail

              echo "ğŸ” Cloud SQLã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®å­˜åœ¨ã‚’ç¢ºèªã—ã¦ã„ã¾ã™..."
              INSTANCE_NAME=$(echo "${_CLOUD_SQL_INSTANCE}" | cut -d':' -f3)
              PROJECT_ID=$(echo "${_CLOUD_SQL_INSTANCE}" | cut -d':' -f1)

              if gcloud sql instances describe "$$INSTANCE_NAME" --project="$$PROJECT_ID" > /dev/null 2>&1; then
                  echo "âœ… Cloud SQLã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ: $$INSTANCE_NAME"
                  echo "true" > /workspace/.cloud_sql_exists
              else
                  echo "âš ï¸  Cloud SQLã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: $$INSTANCE_NAME"
                  echo "   ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ãƒ†ãƒƒãƒ—ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
                  echo "   Terraformã§ã‚¤ãƒ³ãƒ•ãƒ©ã‚’å…ˆã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ãã ã•ã„ã€‚"
                  echo "false" > /workspace/.cloud_sql_exists
              fi
      waitFor: ['Generate Prisma client']

    - id: 'Get Cloud SQL public IP'
      name: 'gcr.io/google.com/cloudsdktool/cloud-sdk:slim'
      entrypoint: 'bash'
      args:
          - '-c'
          - |
              set -euo pipefail

              # Cloud SQLã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®å­˜åœ¨ç¢ºèª
              if [ -f /workspace/.cloud_sql_exists ] && [ "$(cat /workspace/.cloud_sql_exists)" = "false" ]; then
                  echo "â­ï¸  Cloud SQLã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒå­˜åœ¨ã—ãªã„ãŸã‚ã€ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
                  exit 0
              fi

              echo "ğŸ” Cloud SQLã®ãƒ‘ãƒ–ãƒªãƒƒã‚¯IPã‚’å–å¾—ã—ã¦ã„ã¾ã™..."
              INSTANCE_NAME=$(echo "${_CLOUD_SQL_INSTANCE}" | cut -d':' -f3)
              PROJECT_ID=$(echo "${_CLOUD_SQL_INSTANCE}" | cut -d':' -f1)

              PUBLIC_IP=$(gcloud sql instances describe "$$INSTANCE_NAME" \
                  --project="$$PROJECT_ID" \
                  --format="value(ipAddresses[0].ipAddress)" 2>/dev/null || echo "")

              if [ -z "$$PUBLIC_IP" ]; then
                  echo "âš ï¸  ãƒ‘ãƒ–ãƒªãƒƒã‚¯IPãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚Terraformã§ipv4_enabled=trueã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚"
                  echo "false" > /workspace/.cloud_sql_has_public_ip
              else
                  echo "âœ… ãƒ‘ãƒ–ãƒªãƒƒã‚¯IP: $$PUBLIC_IP"
                  echo "$$PUBLIC_IP" > /workspace/.cloud_sql_public_ip
                  echo "true" > /workspace/.cloud_sql_has_public_ip
              fi
      waitFor: ['Check Cloud SQL instance exists']

    - id: 'Apply database migrations'
      name: 'docker.io/library/node@sha256:202ae32103f362765c42bb8283fbec5167cb7c5687feca97ad6bfbf4af3df444'
      entrypoint: 'bash'
      args:
          - '-c'
          - |
              set -euo pipefail

              # DATABASE_URLã‚’å–å¾—ï¼ˆSecret Managerã‹ã‚‰ç›´æ¥å–å¾—ã—ã¦DESTROYEDãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å›é¿ï¼‰
              echo "ğŸ”‘ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šæƒ…å ±ã‚’å–å¾—ã—ã¦ã„ã¾ã™..."
              if [ -z "$$DATABASE_URL" ]; then
                  echo "âŒ DATABASE_URLç’°å¢ƒå¤‰æ•°ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
                  exit 1
              fi

              # Cloud SQLã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®å­˜åœ¨ç¢ºèª
              if [ -f /workspace/.cloud_sql_exists ] && [ "$(cat /workspace/.cloud_sql_exists)" = "false" ]; then
                  echo "â­ï¸  Cloud SQLã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒå­˜åœ¨ã—ãªã„ãŸã‚ã€ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
                  exit 0
              fi

              # ãƒ‘ãƒ–ãƒªãƒƒã‚¯IPã®ç¢ºèª
              if [ -f /workspace/.cloud_sql_has_public_ip ] && [ "$(cat /workspace/.cloud_sql_has_public_ip)" = "false" ]; then
                  echo "âš ï¸  Cloud SQLã«ãƒ‘ãƒ–ãƒªãƒƒã‚¯IPãŒãªã„ãŸã‚ã€ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
                  echo "   Cloud Runãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã€Unix socketçµŒç”±ã§ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚"
                  exit 0
              fi

              PUBLIC_IP=$(cat /workspace/.cloud_sql_public_ip)
              echo "ğŸ”— Cloud SQL ãƒ‘ãƒ–ãƒªãƒƒã‚¯IPçµŒç”±ã§æ¥ç¶šã—ã¾ã™: $$PUBLIC_IP"

              # DATABASE_URLã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼åã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã€DBåã‚’æŠ½å‡ºã—ã¦æ–°ã—ã„URLã‚’æ§‹ç¯‰
              # å…ƒã®å½¢å¼: postgresql://user:pass@/db?host=/cloudsql/...
              DB_URL="$$DATABASE_URL"

              # ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’æŠ½å‡º
              DB_USER=$(echo "$$DB_URL" | sed -n 's|postgresql://\([^:]*\):.*|\1|p')
              # ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’æŠ½å‡ºï¼ˆ@/ã‚ˆã‚Šå‰ã®:ä»¥é™ï¼‰
              DB_PASS=$(echo "$$DB_URL" | sed -n 's|postgresql://[^:]*:\([^@]*\)@.*|\1|p')
              # DBåã‚’æŠ½å‡ºï¼ˆ@/ã¨?ã®é–“ï¼‰
              DB_NAME=$(echo "$$DB_URL" | sed -n 's|.*@/\([^?]*\)?.*|\1|p')

              echo "  ãƒ¦ãƒ¼ã‚¶ãƒ¼: $$DB_USER"
              echo "  DBå: $$DB_NAME"

              # ãƒ‘ãƒ–ãƒªãƒƒã‚¯IPçµŒç”±ã®DATABASE_URLã‚’æ§‹ç¯‰ï¼ˆSSLå¿…é ˆï¼‰
              export DATABASE_URL="postgresql://$$DB_USER:$$DB_PASS@$$PUBLIC_IP:5432/$$DB_NAME?sslmode=require"
              echo "  æ¥ç¶šå…ˆ: postgresql://$$DB_USER:****@$$PUBLIC_IP:5432/$$DB_NAME?sslmode=require"

              # Prismaãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œ
              echo "ğŸ”„ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é©ç”¨ã—ã¦ã„ã¾ã™..."

              # ã¾ãšã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®çŠ¶æ…‹ã‚’ç¢ºèªï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã‹ï¼‰
              echo "ğŸ“Š ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®çŠ¶æ…‹ã‚’ç¢ºèªã—ã¦ã„ã¾ã™..."
              DB_CHECK_OUTPUT=$(npx prisma db execute --stdin <<< "SELECT COUNT(*) FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'users';" 2>&1 || echo "ERROR")
              
              # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒç©ºã®å ´åˆï¼ˆusersãƒ†ãƒ¼ãƒ–ãƒ«ãŒå­˜åœ¨ã—ãªã„ï¼‰
              if echo "$$DB_CHECK_OUTPUT" | grep -qE "(relation.*does not exist|ERROR|0)"; then
                  echo "âš ï¸  ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒç©ºã®çŠ¶æ…‹ã§ã™ã€‚åˆæœŸã‚¹ã‚­ãƒ¼ãƒã‚’é©ç”¨ã—ã¾ã™..."
                  echo "   prisma db push ã‚’ä½¿ç”¨ã—ã¦ã‚¹ã‚­ãƒ¼ãƒã‚’é©ç”¨ã—ã¾ã™..."
                  
                  # prisma db pushã§ã‚¹ã‚­ãƒ¼ãƒã‚’é©ç”¨ï¼ˆé–‹ç™ºç’°å¢ƒç”¨ã ãŒã€ç©ºã®DBã«ã¯æœ‰åŠ¹ï¼‰
                  PUSH_OUTPUT=$(npx prisma db push --accept-data-loss --skip-generate 2>&1)
                  PUSH_EXIT_CODE=$$?
                  
                  if [ $$PUSH_EXIT_CODE -eq 0 ]; then
                      echo "âœ… åˆæœŸã‚¹ã‚­ãƒ¼ãƒã®é©ç”¨ãŒå®Œäº†ã—ã¾ã—ãŸ"
                      echo "ğŸ”„ ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å±¥æ­´ã‚’åˆæœŸåŒ–ã—ã¾ã™..."
                      
                      # ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å±¥æ­´ã‚’åˆæœŸåŒ–ï¼ˆå…¨ã¦ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’baselineã¨ã—ã¦è¨­å®šï¼‰
                      ALL_MIGRATIONS=$(ls -1 prisma/migrations 2>/dev/null | grep -v "^_" | sort)
                      for MIGRATION in $$ALL_MIGRATIONS; do
                          echo "   baselineã¨ã—ã¦è¨­å®š: $$MIGRATION"
                          npx prisma migrate resolve --applied "$$MIGRATION" 2>&1 || true
                      done
                      
                      echo "âœ… ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å±¥æ­´ã®åˆæœŸåŒ–ãŒå®Œäº†ã—ã¾ã—ãŸ"
                      exit 0
                  else
                      echo "âŒ ã‚¹ã‚­ãƒ¼ãƒã®é©ç”¨ã«å¤±æ•—ã—ã¾ã—ãŸ:"
                      echo "$$PUSH_OUTPUT"
                      exit 1
                  fi
              fi

              # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æ—¢å­˜ã®ãƒ†ãƒ¼ãƒ–ãƒ«ãŒã‚ã‚‹å ´åˆã€é€šå¸¸ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œ
              echo "ğŸ“Š æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é©ç”¨ã—ã¾ã™..."

              # æ¥ç¶šã‚¨ãƒ©ãƒ¼ç”¨ã®ãƒªãƒˆãƒ©ã‚¤è¨­å®š
              MAX_RETRIES=5
              RETRY_COUNT=0

              set +e
              while [ $$RETRY_COUNT -lt $$MAX_RETRIES ]; do
                  ERROR_OUTPUT=$(npx prisma migrate deploy 2>&1)
                  EXIT_CODE=$$?

                  if [ $$EXIT_CODE -eq 0 ]; then
                      echo "âœ… ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸ"
                      exit 0
                  fi

                  # æ¥ç¶šã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯ãƒªãƒˆãƒ©ã‚¤
                  if echo "$$ERROR_OUTPUT" | grep -qE "(P1001|P1002|ECONNREFUSED|timeout)"; then
                      RETRY_COUNT=$$((RETRY_COUNT + 1))
                      echo "  æ¥ç¶šã‚¨ãƒ©ãƒ¼ã€‚è©¦è¡Œ $$RETRY_COUNT/$$MAX_RETRIES..."
                      sleep 3
                      continue
                  fi

                  # P3005: æ—¢å­˜ã‚¹ã‚­ãƒ¼ãƒãŒã‚ã‚‹å ´åˆã¯baselineã‚’è¨­å®š
                  if echo "$$ERROR_OUTPUT" | grep -q "P3005"; then
                      echo "âš ï¸  æ—¢å­˜ã®ã‚¹ã‚­ãƒ¼ãƒãŒå­˜åœ¨ã—ã¾ã™ã€‚baselineã‚’è¨­å®šã—ã¾ã™..."
                      FIRST_MIGRATION=$(ls -1 prisma/migrations 2>/dev/null | grep -v "^_" | head -1)
                      if [ -n "$$FIRST_MIGRATION" ]; then
                          npx prisma migrate resolve --applied "$$FIRST_MIGRATION" 2>&1 || true
                          continue
                      fi
                  fi

                  # P3018: ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å¤±æ•—ï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«ãŒå­˜åœ¨ã—ãªã„ãªã©ï¼‰
                  if echo "$$ERROR_OUTPUT" | grep -q "P3018"; then
                      echo "âš ï¸  ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å¤±æ•—ã‚’æ¤œå‡ºã—ã¾ã—ãŸã€‚ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®çŠ¶æ…‹ã‚’ç¢ºèªã—ã¾ã™..."
                      if echo "$$ERROR_OUTPUT" | grep -q "does not exist"; then
                          echo "   ãƒ†ãƒ¼ãƒ–ãƒ«ãŒå­˜åœ¨ã—ãªã„ãŸã‚ã€åˆæœŸã‚¹ã‚­ãƒ¼ãƒã‚’é©ç”¨ã—ã¾ã™..."
                          PUSH_OUTPUT=$(npx prisma db push --accept-data-loss --skip-generate 2>&1)
                          if [ $$? -eq 0 ]; then
                              echo "âœ… åˆæœŸã‚¹ã‚­ãƒ¼ãƒã®é©ç”¨ãŒå®Œäº†ã—ã¾ã—ãŸ"
                              # å…¨ã¦ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’baselineã¨ã—ã¦è¨­å®š
                              ALL_MIGRATIONS=$(ls -1 prisma/migrations 2>/dev/null | grep -v "^_" | sort)
                              for MIGRATION in $$ALL_MIGRATIONS; do
                                  npx prisma migrate resolve --applied "$$MIGRATION" 2>&1 || true
                              done
                              echo "âœ… ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å±¥æ­´ã®åˆæœŸåŒ–ãŒå®Œäº†ã—ã¾ã—ãŸ"
                              exit 0
                          else
                              echo "âŒ ã‚¹ã‚­ãƒ¼ãƒã®é©ç”¨ã«å¤±æ•—ã—ã¾ã—ãŸ"
                              echo "$$PUSH_OUTPUT"
                              exit 1
                          fi
                      fi
                  fi

                  # ãã®ä»–ã®ã‚¨ãƒ©ãƒ¼
                  echo "âŒ ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼:"
                  echo "$$ERROR_OUTPUT"
                  exit 1
              done
              set -e

              echo "âŒ ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆ$$MAX_RETRIESå›è©¦è¡Œï¼‰"
              exit 1
      secretEnv:
          - DATABASE_URL
      waitFor: ['Get Cloud SQL public IP']

    - id: 'Build Next.js app'
      name: 'docker.io/library/node@sha256:202ae32103f362765c42bb8283fbec5167cb7c5687feca97ad6bfbf4af3df444'
      entrypoint: npm
      args: ['run', 'build']
      env:
          - 'NEXT_PUBLIC_APP_URL=${_NEXT_PUBLIC_APP_URL}'
          - 'NEXT_PUBLIC_SUPABASE_URL=${_NEXT_PUBLIC_SUPABASE_URL}'
          # NOTE: DATABASE_URL is NOT set during build - it's only set at runtime in Cloud Run
          # This prevents Next.js from hardcoding the DATABASE_URL during build
      secretEnv:
          - NEXTAUTH_SECRET
          - GOOGLE_CLIENT_ID
          - GOOGLE_CLIENT_SECRET
          - SUPABASE_SERVICE_ROLE_KEY
          - STRIPE_SECRET_KEY
          - STRIPE_WEBHOOK_SECRET
          - GEMINI_API_KEY
          - NEXT_PUBLIC_SUPABASE_ANON_KEY
          - NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY

    - id: 'Build container image'
      name: 'gcr.io/cloud-builders/docker'
      entrypoint: 'bash'
      env:
          - 'NEXT_PUBLIC_APP_URL=${_NEXT_PUBLIC_APP_URL}'
          - 'NEXT_PUBLIC_SUPABASE_URL=${_NEXT_PUBLIC_SUPABASE_URL}'
      secretEnv:
          - NEXTAUTH_SECRET
          - GOOGLE_CLIENT_ID
          - GOOGLE_CLIENT_SECRET
          - GEMINI_API_KEY
          - NEXT_PUBLIC_SUPABASE_ANON_KEY
          - NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY
      args:
          - '-c'
          - |
              docker build \
                --build-arg NEXT_PUBLIC_APP_URL="${_NEXT_PUBLIC_APP_URL}" \
                --build-arg NEXT_PUBLIC_SUPABASE_URL="${_NEXT_PUBLIC_SUPABASE_URL}" \
                --build-arg NEXT_PUBLIC_SUPABASE_ANON_KEY="$$NEXT_PUBLIC_SUPABASE_ANON_KEY" \
                --build-arg NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY="$$NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY" \
                --build-arg GOOGLE_CLIENT_ID=$$GOOGLE_CLIENT_ID \
                --build-arg GOOGLE_CLIENT_SECRET=$$GOOGLE_CLIENT_SECRET \
                --build-arg NEXTAUTH_SECRET=$$NEXTAUTH_SECRET \
                --build-arg GEMINI_API_KEY=$$GEMINI_API_KEY \
                -t asia-northeast1-docker.pkg.dev/${_PROJECT_ID}/${_REPO}/${_IMAGE_NAME}:${SHORT_SHA} \
                -f Dockerfile \
                .

    - id: 'Push container image'
      name: 'gcr.io/cloud-builders/docker'
      args:
          - 'push'
          - 'asia-northeast1-docker.pkg.dev/${_PROJECT_ID}/${_REPO}/${_IMAGE_NAME}:${SHORT_SHA}'

    - id: 'Deploy to Cloud Run'
      name: 'gcr.io/google.com/cloudsdktool/cloud-sdk:slim'
      entrypoint: gcloud
      args:
          - 'run'
          - 'deploy'
          - '${_SERVICE_NAME}'
          - '--project=${_PROJECT_ID}'
          - '--region=${_REGION}'
          - '--image=asia-northeast1-docker.pkg.dev/${_PROJECT_ID}/${_REPO}/${_IMAGE_NAME}:${SHORT_SHA}'
          - '--service-account=${_SERVICE_ACCOUNT}'
          - '--platform=managed'
          - '--vpc-connector=${_VPC_CONNECTOR}'
          - '--set-cloudsql-instances=${_CLOUD_SQL_INSTANCE}'
          - '--ingress=all'
          - '--allow-unauthenticated'
          - '--quiet'

images:
    - 'asia-northeast1-docker.pkg.dev/${_PROJECT_ID}/${_REPO}/${_IMAGE_NAME}:${SHORT_SHA}'
