# Cloud Build pipeline for Creative Flow Studio (Next.js)
# References:
# - https://cloud.google.com/build/docs/deploying-builds/deploy-cloud-run
# - https://cloud.google.com/sql/docs/postgres/connect-run#terraform (Cloud SQL deploy flags)

options:
    logging: CLOUD_LOGGING_ONLY
    machineType: E2_HIGHCPU_8

tags:
    - creative-flow-studio
    - nextjs

substitutions:
    _REGION: asia-northeast1
    _PROJECT_ID: dataanalyticsclinic
    _REPO: creative-flow-studio
    _IMAGE_NAME: app
    _SERVICE_NAME: creative-flow-studio-dev
    _CLOUD_SQL_INSTANCE: dataanalyticsclinic:asia-northeast1:creative-flow-studio-sql
    _VPC_CONNECTOR: projects/dataanalyticsclinic/locations/asia-northeast1/connectors/dev-serverless-connector
    _SERVICE_ACCOUNT: cloud-run-runtime@dataanalyticsclinic.iam.gserviceaccount.com

steps:
    - id: 'Install dependencies'
      name: 'gcr.io/cloud-builders/npm'
      entrypoint: npm
      args: ['ci']

    - id: 'Generate Prisma client'
      name: 'gcr.io/cloud-builders/npm'
      entrypoint: npx
      args: ['prisma', 'generate']

    # TODO: Re-enable once we have a secure way to supply the Cloud SQL credentials during build.
    # - id: 'Apply database migrations'
    #   name: 'gcr.io/cloud-builders/npm'
    #   entrypoint: npx
    #   args: ['prisma', 'migrate', 'deploy']
    #   env:
    #       - 'DATABASE_URL=postgresql://user:password@/creative_flow_studio?host=/cloudsql/${_CLOUD_SQL_INSTANCE}'

    - id: 'Build Next.js app'
      name: 'gcr.io/cloud-builders/npm'
      entrypoint: npm
      args: ['run', 'build']
      env:
          - 'GOOGLE_CLIENT_ID=test-google-client-id'
          - 'GOOGLE_CLIENT_SECRET=test-google-client-secret'
          - 'NEXTAUTH_SECRET=test-secret-for-build-only-32-characters-long'
          - 'GEMINI_API_KEY=AIzaSyDrGsdwBjrkG5Hw_g-RxAcJ-OhzPwURKdk'
          - 'NEXT_PUBLIC_APP_URL=http://localhost:3000'
          - 'NEXT_PUBLIC_SUPABASE_URL=https://kppniwizumnnlhndjnlg.supabase.co'
          - 'NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwcG5pd2l6dW1ubmxobmRqbmxnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5MTEyMTksImV4cCI6MjA3ODQ4NzIxOX0.cCK57jIkvzapDdeSQlNbvR-ukwFfFezSLp5ThMGqZwc'
          - 'NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=pk_live_51P6WQ9Li6CKW3pRaOv6T8Fn4GfIuPVXsJq0mbvTfZM4FgB1BIGha2ttGPwBq6dTSH0N217mWkRoJ8FJcR4uRkTnI00TdFBGidG'

    - id: 'Build container image'
      name: 'gcr.io/cloud-builders/docker'
      args:
          - 'build'
          - '-t'
          - 'asia-northeast1-docker.pkg.dev/${_PROJECT_ID}/${_REPO}/${_IMAGE_NAME}:${SHORT_SHA}'
          - '-f'
          - 'Dockerfile'
          - '.'

    - id: 'Push container image'
      name: 'gcr.io/cloud-builders/docker'
      args:
          - 'push'
          - 'asia-northeast1-docker.pkg.dev/${_PROJECT_ID}/${_REPO}/${_IMAGE_NAME}:${SHORT_SHA}'

    - id: 'Deploy to Cloud Run'
      name: 'gcr.io/google.com/cloudsdktool/cloud-sdk:slim'
      entrypoint: gcloud
      args:
          - 'run'
          - 'deploy'
          - '${_SERVICE_NAME}'
          - '--project=${_PROJECT_ID}'
          - '--region=${_REGION}'
          - '--image=asia-northeast1-docker.pkg.dev/${_PROJECT_ID}/${_REPO}/${_IMAGE_NAME}:${SHORT_SHA}'
          - '--service-account=${_SERVICE_ACCOUNT}'
          - '--platform=managed'
          - '--vpc-connector=${_VPC_CONNECTOR}'
          - '--add-cloudsql-instances=${_CLOUD_SQL_INSTANCE}'
          - '--ingress=all'
          - '--allow-unauthenticated'
          - '--quiet'

images:
    - 'asia-northeast1-docker.pkg.dev/${_PROJECT_ID}/${_REPO}/${_IMAGE_NAME}:${SHORT_SHA}'
